<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Cake 23 (Blow to Blow Out)</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      min-height:100vh; background: #fff7fb;
      padding: 16px;
    }
    h1{ margin: 6px 0 0; font-size: 18px; }
    canvas{
      width:min(92vw, 420px);
      height:auto;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      background: linear-gradient(180deg,#fff,#ffeaf5);
    }
    .panel{
      width:min(92vw, 420px);
      background:#ffffffcc;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:0; border-radius: 14px;
      padding: 10px 12px;
      background:#ff4fa3; color:white; font-weight:700;
      box-shadow: 0 8px 18px rgba(255,79,163,.25);
      cursor:pointer;
    }
    button.secondary{ background:#2b2b2b; box-shadow: 0 8px 18px rgba(0,0,0,.15); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    label{ font-size: 13px; color:#333; }
    input[type="range"]{ width: 220px; }
    .hint{ font-size: 13px; color:#444; line-height:1.4; margin-top: 8px; }
    .meter{
      height: 10px; border-radius: 999px; overflow:hidden;
      background: rgba(0,0,0,.08);
      flex:1; min-width: 160px;
    }
    .meter > div{ height:100%; width:0%; background:#ff4fa3; }
    .status{ font-size: 13px; color:#111; font-weight: 650; }
    .small{ font-size:12px; color:#555; }
    a{ color:#ff2f92; }
  </style>
</head>
<body>
  <h1>üéÇ Cake ‚Äú23‚Äù ‚Äî Th·ªïi v√†o micro ƒë·ªÉ t·∫Øt n·∫øn</h1>
  <canvas id="c" width="420" height="520" aria-label="Birthday cake"></canvas>

  <div class="panel">
    <div class="row">
      <button id="btnStart">üé§ B·∫≠t micro</button>
      <button id="btnRelight" class="secondary" disabled>‚ú® Th·∫Øp l·∫°i n·∫øn</button>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div class="status" id="status">Tr·∫°ng th√°i: Ch∆∞a b·∫≠t micro</div>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <label for="threshold">ƒê·ªô nh·∫°y th·ªïi (Sensitivity):</label>
      <input id="threshold" type="range" min="10" max="70" value="30" />
      <div class="small"><span id="thVal">30</span></div>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <label>√Çm l∆∞·ª£ng hi·ªán t·∫°i:</label>
      <div class="meter"><div id="bar"></div></div>
      <div class="small" id="dbText">0</div>
    </div>

    <div class="hint">
      <b>M·∫πo:</b> Gi·ªØ ƒëi·ªán tho·∫°i c√°ch mi·ªáng ~10‚Äì20cm, th·ªïi ‚Äúph√π‚Äù li√™n t·ª•c 0.4‚Äì0.8 gi√¢y.<br/>
      N·∫øu t·∫Øt kh√¥ng ƒë∆∞·ª£c: tƒÉng ‚Äú√Çm l∆∞·ª£ng‚Äù khi th·ªïi ho·∫∑c k√©o <i>ƒê·ªô nh·∫°y</i> xu·ªëng th·∫•p h∆°n.
      <div class="small" style="margin-top:6px">
        ‚ö†Ô∏è Micro ch·ªâ ho·∫°t ƒë·ªông t·ªët tr√™n <b>HTTPS</b> ho·∫∑c <b>localhost</b>.
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const btnStart = document.getElementById('btnStart');
  const btnRelight = document.getElementById('btnRelight');
  const statusEl = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const thValEl = document.getElementById('thVal');
  const bar = document.getElementById('bar');
  const dbText = document.getElementById('dbText');

  // Candle state
  const candle2 = { x: 165, y: 165, w: 80, h: 120, lit: true, flick: 0 };
  const candle3 = { x: 255, y: 165, w: 80, h: 120, lit: true, flick: 0 };

  let audioCtx, analyser, micStream, data;
  let rafId = null;
  let blowScore = 0; // accumulate "blow" evidence
  let lastVol = 0;

  thValEl.textContent = thresholdEl.value;
  thresholdEl.addEventListener('input', () => thValEl.textContent = thresholdEl.value);

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function drawBackground(){
    // confetti dots
    for (let i=0;i<30;i++){
      const x = (i*37)%420;
      const y = (i*73)%520;
      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.arc(x+10, y+10, 3 + (i%3), 0, Math.PI*2);
      ctx.fillStyle = ['#ff4fa3','#7c5cff','#00c2ff','#ffb300'][i%4];
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  function flame(x,y,scale, t){
    // simple animated flame
    const wobble = Math.sin(t/8) * 3;
    ctx.save();
    ctx.translate(x+wobble, y);
    ctx.scale(scale, scale);

    // outer
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.quadraticCurveTo(14, -10, 6, -28);
    ctx.quadraticCurveTo(0, -44, -6, -28);
    ctx.quadraticCurveTo(-14, -10, 0, 0);
    ctx.closePath();
    ctx.fillStyle = '#ff9a2f';
    ctx.fill();

    // inner
    ctx.beginPath();
    ctx.moveTo(0, -2);
    ctx.quadraticCurveTo(9, -10, 4, -24);
    ctx.quadraticCurveTo(0, -34, -4, -24);
    ctx.quadraticCurveTo(-9, -10, 0, -2);
    ctx.closePath();
    ctx.fillStyle = '#ffe08a';
    ctx.fill();

    ctx.restore();
  }

  function drawCandleNumber(num, c){
    // Candle body
    ctx.save();
    ctx.translate(c.x, c.y);

    // stick base
    ctx.fillStyle = '#ffd1e6';
    roundRect(-c.w/2, 0, c.w, c.h, 18);
    ctx.fill();

    // stripes
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = '#ff4fa3';
    for (let i=0;i<6;i++){
      roundRect(-c.w/2 + 10, 12 + i*18, c.w-20, 10, 8);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // top wax
    ctx.fillStyle = '#ffb3d7';
    roundRect(-c.w/2+8, -10, c.w-16, 26, 14);
    ctx.fill();

    // wick
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(0, -18);
    ctx.lineTo(0, -38);
    ctx.stroke();

    // number
    ctx.fillStyle = '#2b2b2b';
    ctx.font = 'bold 78px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(String(num), 0, c.h/2 - 6);

    ctx.restore();

    // flame if lit
    if (c.lit) flame(c.x, c.y - 40, 0.9, c.flick);
  }

  function drawCake(t){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();

    // plate shadow
    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.ellipse(210, 450, 160, 26, 0, 0, Math.PI*2);
    ctx.fillStyle = '#000';
    ctx.fill();
    ctx.globalAlpha = 1;

    // plate
    ctx.fillStyle = '#ffffff';
    ctx.strokeStyle = 'rgba(0,0,0,.08)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(210, 438, 170, 30, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // cake base
    ctx.fillStyle = '#ffcc8a';
    roundRect(85, 270, 250, 150, 30);
    ctx.fill();

    // frosting
    ctx.fillStyle = '#fff0f7';
    roundRect(70, 240, 280, 70, 30);
    ctx.fill();

    // dripping frosting
    ctx.fillStyle = '#ffe0ef';
    const drips = [
      [95, 300, 26], [140, 315, 40], [190, 305, 30],
      [235, 322, 46], [290, 308, 32], [330, 318, 38]
    ];
    for (const [x,y,h] of drips){
      roundRect(x, 265, 22, h, 11);
      ctx.fill();
    }

    // sprinkles
    const spr = [
      [120,255],[150,260],[175,250],[205,262],[235,252],[265,260],[295,250],[320,260]
    ];
    for (let i=0;i<spr.length;i++){
      ctx.save();
      ctx.translate(spr[i][0], spr[i][1]);
      ctx.rotate((i*22)*Math.PI/180);
      ctx.fillStyle = ['#ff4fa3','#7c5cff','#00c2ff','#ffb300'][i%4];
      roundRect(-8,-2,16,4,2);
      ctx.fill();
      ctx.restore();
    }

    // candles (23)
    candle2.flick = t;
    candle3.flick = t + 20;
    drawCandleNumber(2, candle2);
    drawCandleNumber(3, candle3);

    // greeting
    ctx.fillStyle = 'rgba(0,0,0,.75)';
    ctx.font = '800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Happy 23 üéâ', 210, 70);
    ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = 'rgba(0,0,0,.55)';
    ctx.fillText('Blow into mic to blow out candles', 210, 92);
  }

  function allOut(){ return !candle2.lit && !candle3.lit; }
  function relight(){
    candle2.lit = true; candle3.lit = true;
    blowScore = 0;
    statusEl.textContent = 'Tr·∫°ng th√°i: N·∫øn ƒë√£ ƒë∆∞·ª£c th·∫Øp l·∫°i ‚ú®';
  }

  btnRelight.addEventListener('click', relight);

  function rmsFromTimeDomain(arr){
    let sum = 0;
    for (let i=0;i<arr.length;i++){
      const v = (arr[i] - 128) / 128; // [-1..1]
      sum += v*v;
    }
    return Math.sqrt(sum / arr.length);
  }

  function loop(){
    // draw
    const t = performance.now()/16;
    drawCake(t);

    // audio metering + blow detection
    if (analyser && data){
      analyser.getByteTimeDomainData(data);
      const rms = rmsFromTimeDomain(data);

      // Convert to a friendly 0..100 scale
      const level = Math.min(100, Math.max(0, rms * 140));
      bar.style.width = level + '%';
      dbText.textContent = level.toFixed(0);

      const threshold = Number(thresholdEl.value);

      // "blow" tends to be sustained broadband noise.
      // We'll accumulate score while above threshold, decay otherwise.
      if (level > threshold){
        // reward sustained level, but not sudden spikes only
        const delta = Math.max(0, level - lastVol);
        blowScore += 0.9 + (delta < 8 ? 0.6 : 0.2);
      } else {
        blowScore *= 0.92;
      }
      lastVol = level;

      // If user blows long enough, extinguish one candle at a time
      if (!allOut()){
        if (blowScore > 14 && (candle2.lit || candle3.lit)){
          // extinguish nearest candle first (or 2 then 3)
          if (candle3.lit && !candle2.lit) candle3.lit = false;
          else if (candle2.lit) candle2.lit = false;
          else if (candle3.lit) candle3.lit = false;

          blowScore = 0; // reset after success
          statusEl.textContent = 'Tr·∫°ng th√°i: T·∫Øt ƒë∆∞·ª£c 1 c√¢y n·∫øn! Ti·∫øp t·ª•c th·ªïi n√†o üí®';
        }
      } else {
        statusEl.textContent = 'Tr·∫°ng th√°i: C·∫£ hai n·∫øn ƒë√£ t·∫Øt! üéâ';
        btnRelight.disabled = false;
      }
    }

    rafId = requestAnimationFrame(loop);
  }

  async function startMic(){
    try{
      statusEl.textContent = 'Tr·∫°ng th√°i: ƒêang xin quy·ªÅn micro...';
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      data = new Uint8Array(analyser.fftSize);

      src.connect(analyser);

      btnStart.disabled = true;
      btnRelight.disabled = false;
      statusEl.textContent = 'Tr·∫°ng th√°i: Micro ƒë√£ b·∫≠t ‚úÖ H√£y th·ªïi v√†o micro!';
      if (!rafId) loop();
    } catch(err){
      console.error(err);
      statusEl.textContent = 'Tr·∫°ng th√°i: Kh√¥ng b·∫≠t ƒë∆∞·ª£c micro ‚ùå (h√£y d√πng HTTPS/cho ph√©p quy·ªÅn micro)';
    }
  }

  btnStart.addEventListener('click', startMic);

  // Initial draw (no mic)
  drawCake(0);
})();
</script>
</body>
</html>
