<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÇ Happy Birthday</title>
  <style>
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      background: #fff7fb;
    }
    h1{ margin:6px 0 0; font-size:18px; text-align:center; }
    canvas{
      width:min(92vw, 420px);
      height:auto;
      border-radius:18px;
      background:#fff;
      box-shadow:0 14px 34px rgba(0,0,0,.14);
    }
    .panel{
      width:min(92vw, 420px);
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:0; border-radius:14px;
      padding:10px 12px;
      font-weight:800; cursor:pointer;
      background:#ff4fa3; color:#fff;
      box-shadow:0 10px 20px rgba(255,79,163,.22);
    }
    button.secondary{ background:#2b2b2b; box-shadow:0 10px 20px rgba(0,0,0,.16); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    label{ font-size:13px; color:#333; }
    input[type="range"]{ width:230px; }
    .meter{ height:10px; border-radius:999px; overflow:hidden; background:rgba(0,0,0,.08); flex:1; min-width:160px; }
    .meter > div{ height:100%; width:0%; background:#ff4fa3; }
    .status{ font-size:13px; font-weight:700; color:#111; }
    .small{ font-size:12px; color:#555; }
  </style>
</head>
<body>
  <h1>üéÇ Cake icon ‚Äî th·ªïi v√†o micro ƒë·ªÉ t·∫Øt n·∫øn</h1>

  <canvas id="c" width="420" height="520"></canvas>

  <div class="panel">
    <div class="row">
      <button id="btnStart">üé§ B·∫≠t micro</button>
      <button id="btnRelight" class="secondary" disabled>‚ú® Th·∫Øp l·∫°i n·∫øn</button>
    </div>

    <div style="height:10px"></div>
    <div class="status" id="status">Tr·∫°ng th√°i: Ch∆∞a b·∫≠t micro</div>

    <div style="height:10px"></div>
    <div class="row">
      <label for="threshold">ƒê·ªô nh·∫°y th·ªïi:</label>
      <input id="threshold" type="range" min="10" max="70" value="28" />
      <div class="small"><span id="thVal">28</span></div>
    </div>

    <div style="height:8px"></div>
    <div class="row">
      <label>√Çm l∆∞·ª£ng:</label>
      <div class="meter"><div id="bar"></div></div>
      <div class="small" id="lvlText">0</div>
    </div>

    <div class="small" style="margin-top:8px">
      M·∫πo: ƒë·ªÉ ƒëi·ªán tho·∫°i c√°ch mi·ªáng 10‚Äì20cm v√† th·ªïi ‚Äúph√π‚Äù ~0.5‚Äì1s. N·∫øu kh√≥ t·∫Øt, k√©o ƒë·ªô nh·∫°y xu·ªëng th·∫•p h∆°n.
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const btnStart = document.getElementById('btnStart');
  const btnRelight = document.getElementById('btnRelight');
  const statusEl = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const thValEl = document.getElementById('thVal');
  const bar = document.getElementById('bar');
  const lvlText = document.getElementById('lvlText');

  thValEl.textContent = thresholdEl.value;
  thresholdEl.addEventListener('input', () => thValEl.textContent = thresholdEl.value);

  // candle state
  const candle = { lit: true, flick: 0 };

  // message overlay state
  let showMsg = false;
  let msgT = 0;

  // audio
  let audioCtx, analyser, micStream, data;
  let rafId = null;
  let blowScore = 0;
  let lastLevel = 0;

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function flame(x,y,t){
    const wobble = Math.sin(t/10) * 2.2;
    ctx.save();
    ctx.translate(x+wobble, y);

    // glow
    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.ellipse(0, -10, 18, 24, 0, 0, Math.PI*2);
    ctx.fillStyle = "#ffb300";
    ctx.fill();
    ctx.globalAlpha = 1;

    // outer flame
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.quadraticCurveTo(14, -10, 6, -30);
    ctx.quadraticCurveTo(0, -46, -6, -30);
    ctx.quadraticCurveTo(-14, -10, 0, 0);
    ctx.closePath();
    ctx.fillStyle = "#ff9a2f";
    ctx.fill();

    // inner
    ctx.beginPath();
    ctx.moveTo(0, -3);
    ctx.quadraticCurveTo(8, -12, 4, -26);
    ctx.quadraticCurveTo(0, -36, -4, -26);
    ctx.quadraticCurveTo(-8, -12, 0, -3);
    ctx.closePath();
    ctx.fillStyle = "#ffe08a";
    ctx.fill();

    ctx.restore();
  }

  // üéÇ simple cake icon drawing (clean, emoji-like)
  function drawCakeIcon(t){
    ctx.clearRect(0,0,420,520);

    // soft background dots
    for (let i=0;i<22;i++){
      const x=(i*53)%420, y=(i*79)%520;
      ctx.globalAlpha=0.12;
      ctx.beginPath();
      ctx.arc(x+12,y+16, 3+(i%3), 0, Math.PI*2);
      ctx.fillStyle=["#ff4fa3","#7c5cff","#00c2ff","#ffb300"][i%4];
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // Plate shadow
    ctx.globalAlpha = 0.14;
    ctx.beginPath();
    ctx.ellipse(210, 440, 160, 22, 0, 0, Math.PI*2);
    ctx.fillStyle = "#000";
    ctx.fill();
    ctx.globalAlpha = 1;

    // Plate
    ctx.beginPath();
    ctx.ellipse(210, 430, 170, 26, 0, 0, Math.PI*2);
    ctx.fillStyle = "#f2f2f2";
    ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeStyle="rgba(0,0,0,.06)";
    ctx.stroke();

    // Cake base (golden)
    ctx.fillStyle = "#f6c56f";
    roundRect(105, 260, 210, 140, 36);
    ctx.fill();

    // Cake side highlight
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "#fff";
    roundRect(118, 275, 34, 110, 18);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Cream band (white)
    ctx.fillStyle = "#fff6ef";
    roundRect(105, 315, 210, 46, 22);
    ctx.fill();

    // Sprinkles (tiny)
    const spr = [
      [140,335],[160,344],[178,330],[198,346],[220,332],[240,342],[262,334],[282,346]
    ];
    for(let i=0;i<spr.length;i++){
      ctx.save();
      ctx.translate(spr[i][0], spr[i][1]);
      ctx.rotate((i*18)*Math.PI/180);
      ctx.fillStyle = ["#ff4fa3","#7c5cff","#00c2ff","#ffb300"][i%4];
      roundRect(-7,-2,14,4,2);
      ctx.fill();
      ctx.restore();
    }

    // Chocolate top
    ctx.fillStyle = "#8b4f3a";
    roundRect(90, 230, 240, 56, 28);
    ctx.fill();

    // Chocolate drips (simple scallops)
    ctx.fillStyle = "#7a4433";
    const dripY = 260;
    for(let i=0;i<7;i++){
      ctx.beginPath();
      ctx.ellipse(120 + i*38, dripY, 18, 14, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // Candle (1)
    // candle body
    ctx.fillStyle="#ffe7a8";
    roundRect(200, 165, 20, 70, 10);
    ctx.fill();

    // candle stripe
    ctx.globalAlpha=0.35;
    ctx.fillStyle="#ff4fa3";
    for(let i=0;i<4;i++){
      roundRect(202, 175 + i*14, 16, 6, 4);
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // wick
    ctx.strokeStyle="#1a1a1a";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(210, 160);
    ctx.lineTo(210, 145);
    ctx.stroke();

    // flame if lit
    if (candle.lit){
      candle.flick = t;
      flame(210, 138, t);
    }

    // Title
    ctx.fillStyle="rgba(0,0,0,.72)";
    ctx.font="900 22px system-ui";
    ctx.textAlign="center";
    ctx.fillText("üéÇ", 210, 70);
    ctx.font="800 18px system-ui";
    ctx.fillText("Blow to blow out", 210, 96);
  }

  function drawOverlay(){
    msgT += 1;
    // dim
    ctx.globalAlpha = 0.62;
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,420,520);
    ctx.globalAlpha = 1;

    // pop animation
    const pop = Math.min(1, msgT/16);
    const s = 0.92 + pop*0.08;

    ctx.save();
    ctx.translate(210, 250);
    ctx.scale(s, s);

    // card shadow
    ctx.globalAlpha=0.22;
    ctx.beginPath();
    ctx.ellipse(0, 120, 140, 20, 0, 0, Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha=1;

    // card
    ctx.fillStyle="#fff";
    roundRect(-160, -70, 320, 160, 22);
    ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,.08)";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.textAlign="center";
    ctx.fillStyle="#111";
    ctx.font="950 20px system-ui";
    ctx.fillText("HAPPY BIRTHDAY", 0, -12);

    ctx.fillStyle="#ff2f92";
    ctx.font="1000 22px system-ui";
    ctx.fillText("L√ä VƒÇN L·ªòC", 0, 22);

    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.font="700 12px system-ui";
    ctx.fillText("‚ú® Ch√∫c m·ª´ng sinh nh·∫≠t! ‚ú®", 0, 54);

    ctx.restore();
  }

  function relight(){
    candle.lit = true;
    showMsg = false;
    msgT = 0;
    blowScore = 0;
    statusEl.textContent = "Tr·∫°ng th√°i: N·∫øn ƒë√£ ƒë∆∞·ª£c th·∫Øp l·∫°i ‚ú®";
  }
  btnRelight.addEventListener('click', relight);

  function rmsFromTimeDomain(arr){
    let sum = 0;
    for (let i=0;i<arr.length;i++){
      const v = (arr[i]-128)/128;
      sum += v*v;
    }
    return Math.sqrt(sum/arr.length);
  }

  function frame(){
    const t = performance.now()/16;
    drawCakeIcon(t);

    if (showMsg) drawOverlay();

    if (analyser && data && !showMsg){
      analyser.getByteTimeDomainData(data);
      const rms = rmsFromTimeDomain(data);
      const level = Math.min(100, Math.max(0, rms * 150));

      bar.style.width = level + "%";
      lvlText.textContent = level.toFixed(0);

      const threshold = Number(thresholdEl.value);

      if (level > threshold){
        const delta = Math.max(0, level - lastLevel);
        blowScore += 1.0 + (delta < 10 ? 0.5 : 0.15);
      } else {
        blowScore *= 0.92;
      }
      lastLevel = level;

      // single candle: easier to blow out
      if (candle.lit && blowScore > 12){
        candle.lit = false;
        blowScore = 0;
        statusEl.textContent = "Tr·∫°ng th√°i: N·∫øn ƒë√£ t·∫Øt! üéâ";
        showMsg = true;
        msgT = 0;
      }
    }

    rafId = requestAnimationFrame(frame);
  }

  async function startMic(){
    try{
      statusEl.textContent = "Tr·∫°ng th√°i: ƒêang xin quy·ªÅn micro...";
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      data = new Uint8Array(analyser.fftSize);
      src.connect(analyser);

      btnStart.disabled = true;
      btnRelight.disabled = false;
      statusEl.textContent = "Tr·∫°ng th√°i: Micro ƒë√£ b·∫≠t ‚úÖ H√£y th·ªïi v√†o micro!";
      if (!rafId) frame();
    } catch(e){
      console.error(e);
      statusEl.textContent = "Tr·∫°ng th√°i: Kh√¥ng b·∫≠t ƒë∆∞·ª£c micro ‚ùå (h√£y d√πng HTTPS/cho ph√©p quy·ªÅn micro)";
    }
  }
  btnStart.addEventListener('click', startMic);

  // initial draw
  drawCakeIcon(0);
  frame();
})();
</script>
</body>
</html>
