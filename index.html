<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cake üéÇ</title>
  <style>
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      background: radial-gradient(circle at top, #0b1320, #07101a);
      color:#eaf2ff;
    }
    h1{ margin:6px 0 0; font-size:18px; text-align:center; font-weight:800; }
    canvas{
      width:min(92vw, 420px);
      height:auto;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
    }
    .panel{
      width:min(92vw, 420px);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:0; border-radius:14px;
      padding:10px 12px;
      font-weight:900; cursor:pointer;
      background:#11b5a4; color:#061018;
      box-shadow:0 12px 26px rgba(17,181,164,.20);
    }
    button.secondary{
      background:#1f2a3a; color:#eaf2ff;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    label{ font-size:13px; color:#cfe0ff; }
    input[type="range"]{ width:220px; }
    .meter{ height:10px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.10); flex:1; min-width:150px; }
    .meter > div{ height:100%; width:0%; background:#f5c451; }
    .status{ font-size:13px; font-weight:800; color:#eaf2ff; }
    .small{ font-size:12px; color:#b9cff7; }
  </style>
</head>
<body>
  <h1>üéÇ Simple Cake ‚Äî blow into mic to blow out the candle</h1>

  <canvas id="c" width="420" height="520"></canvas>

  <div class="panel">
    <div class="row">
      <button id="btnStart">üé§ Enable mic</button>
      <button id="btnRelight" class="secondary" disabled>‚ú® Relight</button>
    </div>

    <div style="height:10px"></div>
    <div class="status" id="status">Status: mic is OFF</div>

    <div style="height:10px"></div>
    <div class="row">
      <label for="threshold">Sensitivity:</label>
      <input id="threshold" type="range" min="10" max="70" value="28" />
      <div class="small"><span id="thVal">28</span></div>
    </div>

    <div style="height:8px"></div>
    <div class="row">
      <label>Volume:</label>
      <div class="meter"><div id="bar"></div></div>
      <div class="small" id="lvlText">0</div>
    </div>

    <div class="small" style="margin-top:8px">
      Tip: hold the phone 10‚Äì20cm away and blow for ~0.5‚Äì1s. If it‚Äôs hard, lower Sensitivity.
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const btnStart = document.getElementById('btnStart');
  const btnRelight = document.getElementById('btnRelight');
  const statusEl = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const thValEl = document.getElementById('thVal');
  const bar = document.getElementById('bar');
  const lvlText = document.getElementById('lvlText');

  thValEl.textContent = thresholdEl.value;
  thresholdEl.addEventListener('input', () => thValEl.textContent = thresholdEl.value);

  // --- state
  let candleLit = true;
  let showMsg = false;
  let msgT = 0;

  // --- audio (mic)
  let audioCtx, analyser, micStream, data;
  let blowScore = 0;
  let lastLevel = 0;

  // --- audio (music)
  let musicPlaying = false;

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function flame(x,y,t){
    const wobble = Math.sin(t/10)*2;
    ctx.save();
    ctx.translate(x+wobble,y);
    // glow
    ctx.globalAlpha = 0.20;
    ctx.beginPath(); ctx.ellipse(0,-6,16,22,0,0,Math.PI*2);
    ctx.fillStyle = "#f5c451"; ctx.fill();
    ctx.globalAlpha = 1;
    // outer
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.quadraticCurveTo(12,-10,6,-28);
    ctx.quadraticCurveTo(0,-44,-6,-28);
    ctx.quadraticCurveTo(-12,-10,0,0);
    ctx.closePath();
    ctx.fillStyle="#ff9c2a"; ctx.fill();
    // inner
    ctx.beginPath();
    ctx.moveTo(0,-3);
    ctx.quadraticCurveTo(7,-12,3,-24);
    ctx.quadraticCurveTo(0,-34,-3,-24);
    ctx.quadraticCurveTo(-7,-12,0,-3);
    ctx.closePath();
    ctx.fillStyle="#ffe6a8"; ctx.fill();
    ctx.restore();
  }

  function drawCake(t){
    ctx.clearRect(0,0,420,520);

    // subtle stars
    ctx.globalAlpha = 0.20;
    for(let i=0;i<18;i++){
      const x = (i*59)%420;
      const y = (i*97)%520;
      ctx.beginPath();
      ctx.arc(x+10,y+12, 2+(i%2), 0, Math.PI*2);
      ctx.fillStyle = ["#11b5a4","#f5c451","#9bbcff","#ffffff"][i%4];
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // plate shadow
    ctx.globalAlpha=0.22;
    ctx.beginPath(); ctx.ellipse(210, 440, 160, 22, 0, 0, Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha=1;

    // plate
    ctx.beginPath(); ctx.ellipse(210, 430, 170, 26, 0, 0, Math.PI*2);
    ctx.fillStyle="#0f2434"; ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.12)";
    ctx.lineWidth=2; ctx.stroke();

    // cake body (emoji-like)
    ctx.fillStyle="#f3c07a"; // warm gold
    roundRect(105, 260, 210, 140, 36);
    ctx.fill();

    // cream band
    ctx.fillStyle="#e9f1ff";
    roundRect(105, 315, 210, 46, 22);
    ctx.fill();

    // sprinkles (minimal)
    const spr = [[140,338],[165,330],[190,345],[215,333],[240,344],[265,334],[285,345]];
    for(let i=0;i<spr.length;i++){
      ctx.save();
      ctx.translate(spr[i][0], spr[i][1]);
      ctx.rotate((i*20)*Math.PI/180);
      ctx.fillStyle = ["#11b5a4","#f5c451","#9bbcff"][i%3];
      roundRect(-7,-2,14,4,2);
      ctx.fill();
      ctx.restore();
    }

    // top icing (charcoal)
    ctx.fillStyle="#1f2a3a";
    roundRect(90, 230, 240, 56, 28);
    ctx.fill();

    // drips
    ctx.fillStyle="#182234";
    const dripY=260;
    for(let i=0;i<7;i++){
      ctx.beginPath();
      ctx.ellipse(120+i*38, dripY, 18, 14, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // candle
    ctx.fillStyle="#e9f1ff";
    roundRect(200, 165, 20, 70, 10);
    ctx.fill();
    ctx.globalAlpha=0.25;
    ctx.fillStyle="#11b5a4";
    for(let i=0;i<4;i++){ roundRect(202, 175+i*14, 16, 6, 4); ctx.fill(); }
    ctx.globalAlpha=1;

    // wick
    ctx.strokeStyle="#0b0f16";
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(210, 160); ctx.lineTo(210, 145); ctx.stroke();

    // flame
    if(candleLit) flame(210, 138, t);

    // title
    ctx.fillStyle="rgba(234,242,255,.92)";
    ctx.font="900 22px system-ui";
    ctx.textAlign="center";
    ctx.fillText("üéÇ", 210, 70);
    ctx.font="800 14px system-ui";
    ctx.fillStyle="rgba(234,242,255,.65)";
    ctx.fillText("Blow into mic to blow out the candle", 210, 96);

    if(showMsg) drawOverlay();
  }

  function drawOverlay(){
    msgT += 1;
    ctx.globalAlpha=0.60;
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,420,520);
    ctx.globalAlpha=1;

    const pop = Math.min(1, msgT/16);
    const s = 0.92 + pop*0.08;

    ctx.save();
    ctx.translate(210, 250);
    ctx.scale(s, s);

    ctx.globalAlpha=0.26;
    ctx.beginPath(); ctx.ellipse(0, 120, 140, 20, 0, 0, Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha=1;

    ctx.fillStyle="#0f2434";
    roundRect(-160, -70, 320, 160, 22);
    ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.textAlign="center";
    ctx.fillStyle="#e9f1ff";
    ctx.font="950 20px system-ui";
    ctx.fillText("HAPPY BIRTHDAY", 0, -12);

    ctx.fillStyle="#f5c451";
    ctx.font="1000 22px system-ui";
    ctx.fillText("L√ä VƒÇN L·ªòC", 0, 22);

    ctx.fillStyle="rgba(233,241,255,.70)";
    ctx.font="800 12px system-ui";
    ctx.fillText("‚ú® Make a wish ‚ú®", 0, 54);

    ctx.restore();
  }

  // --- Happy Birthday melody (WebAudio)
  function playHappyBirthday(){
    if(!audioCtx || musicPlaying) return;
    musicPlaying = true;

    const A4 = 440;
    const notes = {
      C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00,
      Bb4: 466.16, C5: 523.25, D5: 587.33, E5: 659.25
    };

    // Simple ‚ÄúHappy Birthday‚Äù (one verse) in C major
    const seq = [
      ["G4", 0.35], ["G4", 0.20], ["A4", 0.55], ["G4", 0.55], ["C5", 0.55], ["B b4".replace(" ",""), 0.95],
      ["G4", 0.35], ["G4", 0.20], ["A4", 0.55], ["G4", 0.55], ["D5", 0.55], ["C5", 0.95],
      ["G4", 0.35], ["G4", 0.20], ["G5".replace("G5","E5"), 0.55], ["C5", 0.55], ["C5", 0.55], ["B b4".replace(" ",""), 0.55], ["A4", 0.95],
      ["F4", 0.35], ["F4", 0.20], ["E4", 0.55], ["C5", 0.55], ["D5", 0.55], ["C5", 1.15],
    ];

    const now = audioCtx.currentTime + 0.02;
    let t = now;

    const master = audioCtx.createGain();
    master.gain.value = 0.18;
    master.connect(audioCtx.destination);

    for(const [n, dur] of seq){
      const f = notes[n] || notes.C4;

      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      osc.type = "sine";
      osc.frequency.value = f;

      // ADSR-ish envelope
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(1.0, t + 0.02);
      g.gain.linearRampToValueAtTime(0.35, t + dur - 0.05);
      g.gain.linearRampToValueAtTime(0.0001, t + dur);

      osc.connect(g);
      g.connect(master);

      osc.start(t);
      osc.stop(t + dur);

      t += dur;
    }

    // reset flag after done
    setTimeout(() => { musicPlaying = false; }, Math.ceil((t - now) * 1000) + 200);
  }

  function relight(){
    candleLit = true;
    showMsg = false;
    msgT = 0;
    blowScore = 0;
    statusEl.textContent = "Status: relit ‚ú®";
  }
  btnRelight.addEventListener('click', relight);

  function rmsFromTimeDomain(arr){
    let sum = 0;
    for(let i=0;i<arr.length;i++){
      const v = (arr[i]-128)/128;
      sum += v*v;
    }
    return Math.sqrt(sum/arr.length);
  }

  function loop(){
    const t = performance.now()/16;
    drawCake(t);

    if (analyser && data && !showMsg){
      analyser.getByteTimeDomainData(data);
      const rms = rmsFromTimeDomain(data);
      const level = Math.min(100, Math.max(0, rms * 150));

      bar.style.width = level + "%";
      lvlText.textContent = level.toFixed(0);

      const threshold = Number(thresholdEl.value);

      if(level > threshold){
        const delta = Math.max(0, level - lastLevel);
        blowScore += 1.0 + (delta < 10 ? 0.5 : 0.2);
      } else {
        blowScore *= 0.92;
      }
      lastLevel = level;

      if(candleLit && blowScore > 12){
        candleLit = false;
        blowScore = 0;
        statusEl.textContent = "Status: candle is OUT üéâ";
        showMsg = true;
        msgT = 0;
        playHappyBirthday(); // music on blow-out
      }
    }

    requestAnimationFrame(loop);
  }

  async function startMic(){
    try{
      statusEl.textContent = "Status: requesting mic permission...";
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      data = new Uint8Array(analyser.fftSize);
      src.connect(analyser);

      btnStart.disabled = true;
      btnRelight.disabled = false;
      statusEl.textContent = "Status: mic is ON ‚úÖ Blow!";
    } catch(e){
      console.error(e);
      statusEl.textContent = "Status: mic failed ‚ùå (need HTTPS + allow mic)";
    }
  }
  btnStart.addEventListener('click', startMic);

  // initial
  loop();
})();
</script>
</body>
</html>
