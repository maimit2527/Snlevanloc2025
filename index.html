<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Birthday Candle</title>
<style>
  :root{
    --charcoal:#2b2b2b;
    --navy:#0b3d91;
    --teal:#0f4c4c;
    --gold:#d4af37;
    --bg:#0f1720;
    --card:#111418;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,var(--bg),#081018);
    color: #e6eef8;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    box-sizing:border-box;
  }
  .wrap{
    width:100%;
    max-width:420px;
    text-align:center;
  }
  .card{
    background: linear-gradient(180deg,var(--card),#0b1014);
    border-radius:14px;
    padding:18px;
    box-shadow: 0 6px 24px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  canvas{
    width:100%;
    max-width:360px;
    height:auto;
    display:block;
    margin:8px auto 14px;
    touch-action:none;
  }
  .controls{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    align-items:center;
    margin-top:8px;
  }
  .full{
    grid-column:1 / -1;
  }
  button{
    background:var(--navy);
    color:white;
    border:0;
    padding:10px 12px;
    border-radius:8px;
    font-weight:700;
    letter-spacing:0.6px;
    box-shadow: 0 4px 10px rgba(11,61,145,0.18);
    cursor:pointer;
  }
  button.secondary{
    background:var(--teal);
    box-shadow: 0 4px 10px rgba(15,76,76,0.18);
  }
  .row{
    display:flex;
    gap:8px;
    align-items:center;
  }
  label{
    font-size:13px;
    color:#cfe3ff;
    display:block;
    text-align:left;
  }
  input[type="range"]{
    -webkit-appearance:none;
    appearance:none;
    height:28px;
    background:transparent;
  }
  input[type="range"]::-webkit-slider-runnable-track{
    height:6px;
    background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.02));
    border-radius:6px;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:18px;height:18px;border-radius:50%;
    background:var(--gold);
    margin-top:-6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.5);
  }
  .meter{
    width:100%;
    height:12px;
    background:rgba(255,255,255,0.04);
    border-radius:8px;
    overflow:hidden;
    display:flex;
    align-items:center;
  }
  .meter-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--gold),#ffd46a);
    border-radius:8px 0 0 8px;
    transition:width 0.08s linear;
  }
  .small{
    font-size:13px;color:#cfe3ff;
  }
  .meter-wrap{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:6px;
  }
  .value{
    min-width:48px;
    text-align:right;
    font-weight:700;
    color:var(--gold);
    font-size:13px;
  }

  /* Overlay after blown */
  .overlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .celebrate{
    background:rgba(11,16,20,0.88);
    border:2px solid rgba(255,255,255,0.04);
    color:var(--gold);
    padding:28px 22px;
    border-radius:12px;
    transform-origin:center;
    text-align:center;
    box-shadow: 0 12px 40px rgba(2,6,23,0.8);
    opacity:0;
    transform:translateY(20px) scale(0.96);
    transition:opacity 420ms cubic-bezier(.2,.9,.2,1), transform 420ms cubic-bezier(.2,.9,.2,1);
    pointer-events:auto;
    max-width:90%;
  }
  .celebrate.show{
    opacity:1;
    transform:translateY(0) scale(1);
  }
  .celebrate h1{
    margin:0;
    font-size:22px;
    letter-spacing:2px;
    color:#eaf4ff;
    font-weight:900;
    line-height:1;
  }
  .celebrate p{
    margin:10px 0 0;
    font-size:20px;
    font-weight:900;
    letter-spacing:1.8px;
    color:var(--gold);
  }

  /* small footer */
  .help{
    margin-top:12px;
    font-size:12px;
    color:#9fb6e6;
  }

  @media(min-width:600px){
    .celebrate h1{font-size:26px;}
    .celebrate p{font-size:28px;}
  }

  /* subtle focus */
  button:focus, input[type="range"]:focus{outline:3px solid rgba(212,175,55,0.12);}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main" aria-labelledby="title">
    <h2 id="title" style="margin:0 0 8px;font-size:16px;color:#dbefff;">Blow Out the Candle</h2>
    <canvas id="canvas" width="720" height="540" aria-label="Birthday cake with candle"></canvas>

    <div class="controls" style="margin-top:12px;">
      <button id="micBtn" class="full">Enable microphone</button>
      <button id="relightBtn" class="secondary full" style="display:none;">Relight candle</button>

      <div class="full" style="margin-top:4px;">
        <label for="sensitivity">Sensitivity <span id="sensVal" style="float:right;color:var(--gold);font-weight:800">40</span></label>
        <input id="sensitivity" type="range" min="10" max="70" value="40" />
      </div>

      <div class="full meter-wrap" style="margin-top:4px;">
        <div style="flex:1;">
          <label class="small">Live volume</label>
          <div class="meter" aria-hidden="true">
            <div id="meterFill" class="meter-fill"></div>
          </div>
        </div>
        <div class="value" id="volVal">0</div>
      </div>

    </div>

    <div class="help">Tip: Tap "Enable microphone" then blow gently at your device's mic to extinguish the flame.</div>
  </div>
</div>

<div class="overlay" id="overlay" aria-hidden="true">
  <div class="celebrate" id="celebrate">
    <h1>HAPPY BIRTHDAY</h1>
    <p>LÊ VĂN LỘC</p>
  </div>
</div>

<script>
(function(){
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  // for crispness on high-DPI
  function fitCanvas(){
    const ratio = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth;
    const cssH = Math.round(cssW * (3/4)); // keep aspect
    canvas.style.height = cssH + 'px';
    canvas.width = Math.round(cssW * ratio);
    canvas.height = Math.round(cssH * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  fitCanvas();
  window.addEventListener('resize', fitCanvas);

  // Colors
  const C = {
    charcoal:'#2b2b2b',
    navy:'#0b3d91',
    teal:'#0f4c4c',
    gold:'#d4af37',
    plate:'#111418'
  };

  let flameOn = true;
  let flickerSeed = Math.random()*1000;
  let lastFrame = 0;

  function draw(){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    ctx.clearRect(0,0,w,h);

    // background simple
    // plate shadow
    const cx = w/2;
    const cakeW = Math.min(260, w*0.65);
    const cakeH = cakeW * 0.62;
    const plateW = cakeW*1.25;
    const plateH = 18;
    const cakeX = cx - cakeW/2;
    const cakeY = h*0.52 - cakeH/2;

    // draw plate
    ctx.beginPath();
    ctx.fillStyle = C.plate;
    roundRect(ctx, cx - plateW/2, cakeY + cakeH + 8, plateW, plateH, plateH/2);
    ctx.fill();

    // plate rim
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    roundRect(ctx, cx - plateW/2 + 6, cakeY + cakeH + 10, plateW-12, plateH-6, (plateH-6)/2);
    ctx.fill();

    // cake body (rounded)
    ctx.beginPath();
    ctx.fillStyle = C.navy;
    roundRect(ctx, cakeX, cakeY, cakeW, cakeH, 18);
    ctx.fill();

    // icing - top rounded strip in teal
    ctx.beginPath();
    ctx.fillStyle = C.teal;
    roundRect(ctx, cakeX+8, cakeY+8, cakeW-16, cakeH*0.36, 12);
    ctx.fill();

    // minimal decoration: three small charcoal dots
    ctx.fillStyle = C.charcoal;
    const decY = cakeY + cakeH*0.5;
    for(let i=-1;i<=1;i++){
      ctx.beginPath();
      ctx.arc(cx + i*44, decY, 6, 0, Math.PI*2);
      ctx.fill();
    }

    // candle - single centered
    const candleW = 16;
    const candleH = 60;
    const candleX = cx - candleW/2;
    const candleY = cakeY - candleH + 6;

    // candle body (charcoal stripes)
    ctx.beginPath();
    ctx.fillStyle = C.gold;
    roundRect(ctx, candleX+1, candleY, candleW-2, candleH, 6);
    ctx.fill();

    // thin stripes on candle (navy)
    ctx.fillStyle = 'rgba(11,61,145,0.12)';
    for(let s=0;s<3;s++){
      ctx.fillRect(candleX+3, candleY + 8 + s*16, candleW-6, 4);
    }

    // wick
    ctx.beginPath();
    ctx.fillStyle = C.charcoal;
    ctx.fillRect(cx-1, candleY-6, 2,6);

    // flame (simple teardrop) with flicker when on
    if(flameOn){
      const t = performance.now()/120 + flickerSeed;
      const flick = 1 + Math.sin(t)*0.12 + Math.sin(t*1.7)*0.08;
      const flameH = 26 * flick;
      const flameW = 14 * flick;
      drawFlame(cx, candleY-8, flameW, flameH);
    }

    // small glow when on
    if(flameOn){
      ctx.beginPath();
      const grad = ctx.createRadialGradient(cx, candleY-8, 6, cx, candleY-8, 60);
      grad.addColorStop(0, 'rgba(212,175,55,0.12)');
      grad.addColorStop(1, 'rgba(212,175,55,0)');
      ctx.fillStyle = grad;
      ctx.arc(cx, candleY-8, 56, 0, Math.PI*2);
      ctx.fill();
    } else {
      // faint smoke suggestion (rounded small grey blob)
      ctx.beginPath();
      ctx.fillStyle = 'rgba(255,255,255,0.03)';
      ctx.ellipse(cx, candleY-18, 10, 6, -0.5, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(cx+8, candleY-32, 6, 4, -0.4, 0, Math.PI*2);
      ctx.fill();
    }

    // small title indicator (optional)
    lastFrame = requestAnimationFrame(draw);
  }

  function roundRect(ctx,x,y,w,h,r){
    const rad = r||6;
    ctx.moveTo(x+rad,y);
    ctx.lineTo(x+w-rad,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+rad);
    ctx.lineTo(x+w,y+h-rad);
    ctx.quadraticCurveTo(x+w,y+h,x+w-rad,y+h);
    ctx.lineTo(x+rad,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-rad);
    ctx.lineTo(x,y+rad);
    ctx.quadraticCurveTo(x,y,x+rad,y);
  }

  function drawFlame(x,y,w,h){
    // simple teardrop with two-tone (gold + lighter)
    // main
    ctx.beginPath();
    const topX = x;
    const topY = y - h*0.9;
    ctx.moveTo(topX, topY);
    ctx.quadraticCurveTo(x + w*0.6, y - h*0.2, x + w*0.2, y + h*0.2);
    ctx.quadraticCurveTo(x + w*0.05, y + h*0.4, x, y);
    ctx.quadraticCurveTo(x - w*0.05, y + h*0.4, x - w*0.2, y + h*0.2);
    ctx.quadraticCurveTo(x - w*0.6, y - h*0.2, topX, topY);
    ctx.closePath();
    const g = ctx.createLinearGradient(x, y-h, x, y+h);
    g.addColorStop(0,'#fff7d1');
    g.addColorStop(0.4,C.gold);
    g.addColorStop(1,'rgba(212,175,55,0.6)');
    ctx.fillStyle = g;
    ctx.fill();

    // inner small highlight
    ctx.beginPath();
    ctx.moveTo(topX, topY+2);
    ctx.quadraticCurveTo(x + w*0.28, y - h*0.12, x + w*0.08, y + h*0.14);
    ctx.quadraticCurveTo(x + w*0.02, y + h*0.22, topX, y + h*0.06);
    ctx.closePath();
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.fill();
  }

  // start draw loop
  draw();

  // Audio + mic logic
  const micBtn = document.getElementById('micBtn');
  const relightBtn = document.getElementById('relightBtn');
  const sensitivity = document.getElementById('sensitivity');
  const sensVal = document.getElementById('sensVal');
  const meterFill = document.getElementById('meterFill');
  const volVal = document.getElementById('volVal');
  const overlay = document.getElementById('overlay');
  const celebrate = document.getElementById('celebrate');

  sensVal.textContent = sensitivity.value;

  sensitivity.addEventListener('input', ()=>{ sensVal.textContent = sensitivity.value; });

  let audioCtx = null;
  let analyser = null;
  let mediaStream = null;
  let sourceNode = null;
  let rafId = null;
  let allowAudioPlay = false;
  let lastHigh = 0;
  let blowDetected = false;
  let musicPlaying = false;
  let scheduledNodes = [];
  let userInteractedToEnable = false;

  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  async function initMic(){
    try{
      ensureAudioContext();
      await audioCtx.resume();
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true }, video:false });
      sourceNode = audioCtx.createMediaStreamSource(mediaStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      analyser.smoothingTimeConstant = 0.2;
      sourceNode.connect(analyser);
      startMonitoring();
      micBtn.textContent = 'Microphone enabled';
      micBtn.disabled = true;
      micBtn.style.opacity = '0.9';
      relightBtn.style.display = 'inline-block';
      allowAudioPlay = true;
      userInteractedToEnable = true;
    }catch(e){
      console.warn('mic error', e);
      alert('Microphone access was denied or is unavailable.');
    }
  }

  micBtn.addEventListener('click', async ()=> {
    // create/resume audio context & get mic
    if(!audioCtx) ensureAudioContext();
    // resume if suspended
    try{
      await audioCtx.resume();
    }catch(e){}
    await initMic();
  });

  relightBtn.addEventListener('click', ()=> {
    relight();
  });

  function relight(){
    flameOn = true;
    blowDetected = false;
    overlay.setAttribute('aria-hidden','true');
    celebrate.classList.remove('show');
    stopMusic();
  }

  function startMonitoring(){
    const buffer = new Uint8Array(analyser.fftSize);
    const minDuration = 80; // ms at least
    const maxDuration = 1200; // don't accept extremely long
    const thresholdFactor = ()=> (parseInt(sensitivity.value,10) / 100); // 0.1 - 0.7

    function step(){
      analyser.getByteTimeDomainData(buffer);
      // convert to [-1,1]
      let sum = 0;
      for(let i=0;i<buffer.length;i++){
        const v = (buffer[i] - 128)/128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum / buffer.length);
      const vol = Math.min(1, rms*3); // scale for display
      const volPercent = Math.round(vol*100);
      meterFill.style.width = (volPercent)+'%';
      volVal.textContent = volPercent;

      // detect blow: large short spike above threshold
      const dynamicThreshold = thresholdFactor() * 0.65; // base
      // We'll consider blowing as rms > dynamicThreshold
      if(flameOn && !blowDetected){
        if(rms > dynamicThreshold){
          if(!lastHigh) lastHigh = performance.now();
          else {
            const dur = performance.now() - lastHigh;
            if(dur > minDuration && dur < maxDuration){
              // extra guard: ensure strong enough absolute
              if(rms > 0.08){
                // Consider blow
                blowDetected = true;
                extinguish();
              }
            }
          }
        } else {
          lastHigh = 0;
        }
      }

      rafId = requestAnimationFrame(step);
    }
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(step);
  }

  function extinguish(){
    flameOn = false;
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=> celebrate.classList.add('show'), 40);
    // play music only if user enabled mic (interaction)
    if(allowAudioPlay && userInteractedToEnable){
      playHappyBirthday();
    }
  }

  // Music generation - Happy Birthday melody (simple)
  const notes = {
    'C4':261.63,'C#4':277.18,'D4':293.66,'D#4':311.13,'E4':329.63,'F4':349.23,'F#4':369.99,'G4':392.00,'G#4':415.30,'A4':440.00,'A#4':466.16,'B4':493.88,
    'C5':523.25,'D5':587.33,'E5':659.25,'F5':698.46,'G5':783.99
  };
  // sequence: note, length in beats (relative), pause flag optional
  // tempo control
  const melody = [
    ['G4',1], ['G4',1], ['A4',2], ['G4',2], ['C5',2], ['B4',4],
    ['G4',1], ['G4',1], ['A4',2], ['G4',2], ['D5',2], ['C5',4],
    ['G4',1], ['G4',1], ['G5',2], ['E5',2], ['C5',2], ['B4',2], ['A4',4],
    ['F5',1], ['F5',1], ['E5',2], ['C5',2], ['D5',2], ['C5',4]
  ];

  function stopMusic(){
    scheduledNodes.forEach(n=>{
      try{ n.osc.stop(0); }catch(e){}
      try{ n.gain.disconnect(); }catch(e){}
    });
    scheduledNodes = [];
    musicPlaying = false;
  }

  function playHappyBirthday(){
    if(!audioCtx) ensureAudioContext();
    if(audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
    stopMusic();
    musicPlaying = true;
    const tempo = 110; // BPM
    const beatDur = 60/tempo; // seconds
    let when = audioCtx.currentTime + 0.05;
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.16;
    masterGain.connect(audioCtx.destination);

    for(let i=0;i<melody.length;i++){
      const [note,len] = melody[i];
      const freq = notes[note] || 440;
      const dur = beatDur * len * 0.95;
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = freq;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, when);
      g.gain.exponentialRampToValueAtTime(1.0, when + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, when + dur);
      osc.connect(g);
      g.connect(masterGain);
      osc.start(when);
      osc.stop(when + dur + 0.03);
      scheduledNodes.push({osc:osc,gain:g});
      when += dur + (beatDur*0.05);
    }
    // cleanup nodes after the melody ends
    const finish = when + 0.1;
    setTimeout(()=>{ stopMusic(); }, (finish - audioCtx.currentTime)*1000 + 200);
  }

  // ensure cleanup on page hide
  window.addEventListener('pagehide', ()=>{
    if(mediaStream){
      mediaStream.getTracks().forEach(t=>t.stop());
    }
    stopMusic();
  });

})();
</script>
</body>
</html>
