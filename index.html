<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Cake 23</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      min-height:100vh; background: #fff;
      padding: 16px;
    }
    h1{ margin: 6px 0 0; font-size: 18px; text-align:center; }
    canvas{
      width:min(92vw, 420px);
      height:auto;
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.14);
      background: #ffffff;
    }
    .panel{
      width:min(92vw, 420px);
      background:#ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:0; border-radius: 14px;
      padding: 10px 12px;
      background:#ff4fa3; color:white; font-weight:800;
      box-shadow: 0 8px 18px rgba(255,79,163,.25);
      cursor:pointer;
    }
    button.secondary{ background:#2b2b2b; box-shadow: 0 8px 18px rgba(0,0,0,.15); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    label{ font-size: 13px; color:#333; }
    input[type="range"]{ width: 230px; }
    .hint{ font-size: 13px; color:#444; line-height:1.35; margin-top: 8px; }
    .meter{
      height: 10px; border-radius: 999px; overflow:hidden;
      background: rgba(0,0,0,.08);
      flex:1; min-width: 160px;
    }
    .meter > div{ height:100%; width:0%; background:#ff4fa3; }
    .status{ font-size: 13px; color:#111; font-weight: 700; }
    .small{ font-size:12px; color:#555; }
  </style>
</head>
<body>
  <h1>üéÇ Cake ‚Äú23‚Äù ‚Äî Th·ªïi v√†o micro ƒë·ªÉ t·∫Øt n·∫øn</h1>
  <canvas id="c" width="420" height="520"></canvas>

  <div class="panel">
    <div class="row">
      <button id="btnStart">üé§ B·∫≠t micro</button>
      <button id="btnRelight" class="secondary" disabled>‚ú® Th·∫Øp l·∫°i n·∫øn</button>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div class="status" id="status">Tr·∫°ng th√°i: Ch∆∞a b·∫≠t micro</div>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <label for="threshold">ƒê·ªô nh·∫°y th·ªïi (Sensitivity):</label>
      <input id="threshold" type="range" min="10" max="70" value="28" />
      <div class="small"><span id="thVal">28</span></div>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <label>√Çm l∆∞·ª£ng hi·ªán t·∫°i:</label>
      <div class="meter"><div id="bar"></div></div>
      <div class="small" id="lvlText">0</div>
    </div>

    <div class="hint">
      M·∫πo: ƒê·ªÉ ƒëi·ªán tho·∫°i c√°ch mi·ªáng 10‚Äì20cm v√† th·ªïi ‚Äúph√π‚Äù li√™n t·ª•c ~0.5s.
      N·∫øu kh√≥ t·∫Øt: k√©o <b>ƒê·ªô nh·∫°y</b> xu·ªëng th·∫•p h∆°n.
      <div class="small" style="margin-top:6px">
        (Micro th∆∞·ªùng ch·ªâ ch·∫°y t·ªët tr√™n <b>HTTPS</b> / GitHub Pages)
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const btnStart = document.getElementById('btnStart');
  const btnRelight = document.getElementById('btnRelight');
  const statusEl = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const thValEl = document.getElementById('thVal');
  const bar = document.getElementById('bar');
  const lvlText = document.getElementById('lvlText');

  thValEl.textContent = thresholdEl.value;
  thresholdEl.addEventListener('input', () => thValEl.textContent = thresholdEl.value);

  // candle state
  const candle2 = { x: 165, y: 170, lit: true, flick: 0 };
  const candle3 = { x: 255, y: 170, lit: true, flick: 0 };

  // message state
  let showMsg = false;
  let msgT = 0;
  let confetti = [];

  // audio
  let audioCtx, analyser, micStream, data;
  let rafId = null;
  let blowScore = 0;
  let lastLevel = 0;

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function star(x,y,r,rot){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(rot);
    ctx.beginPath();
    for(let i=0;i<10;i++){
      const ang = i*Math.PI/5;
      const rr = (i%2===0)? r : r*0.45;
      ctx.lineTo(Math.cos(ang)*rr, Math.sin(ang)*rr);
    }
    ctx.closePath();
    ctx.restore();
  }

  function flame(x,y,t,scale=1){
    const wobble = Math.sin(t/10) * 2.2;
    ctx.save();
    ctx.translate(x+wobble, y);
    ctx.scale(scale, scale);

    // glow
    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.ellipse(0,-18,18,26,0,0,Math.PI*2);
    ctx.fillStyle = "#ffb000";
    ctx.fill();
    ctx.globalAlpha = 1;

    // outer flame
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.quadraticCurveTo(14,-10, 7,-30);
    ctx.quadraticCurveTo(0,-46, -7,-30);
    ctx.quadraticCurveTo(-14,-10, 0,0);
    ctx.closePath();
    ctx.fillStyle = "#ff9a2f";
    ctx.fill();

    // inner flame
    ctx.beginPath();
    ctx.moveTo(0,-2);
    ctx.quadraticCurveTo(8,-12, 4,-26);
    ctx.quadraticCurveTo(0,-36, -4,-26);
    ctx.quadraticCurveTo(-8,-12, 0,-2);
    ctx.closePath();
    ctx.fillStyle = "#ffe08a";
    ctx.fill();

    ctx.restore();
  }

  // Draw ‚Äú2‚Äù candle body (vector-style, glossy)
  function drawCandleNumber2(x,y){
    ctx.save();
    ctx.translate(x,y);

    // shadow on cake
    ctx.globalAlpha = 0.12;
    ctx.beginPath(); ctx.ellipse(0,96,40,10,0,0,Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha = 1;

    // body path for 2
    ctx.beginPath();
    ctx.moveTo(-28,10);
    ctx.quadraticCurveTo(-10,-34, 20,-24);
    ctx.quadraticCurveTo(54,-12, 28,18);
    ctx.quadraticCurveTo(16,32, -4,44);
    ctx.quadraticCurveTo(-28,58, -30,78);
    ctx.quadraticCurveTo(-32,98, -6,96);
    ctx.lineTo(28,96);
    ctx.quadraticCurveTo(40,96, 40,110);
    ctx.lineTo(40,122);
    ctx.lineTo(-40,122);
    ctx.lineTo(-40,106);
    ctx.quadraticCurveTo(-40,80, -18,64);
    ctx.quadraticCurveTo(2,50, 14,40);
    ctx.quadraticCurveTo(32,26, 22,10);
    ctx.quadraticCurveTo(12,-6, -8,-2);
    ctx.quadraticCurveTo(-20,1, -28,14);
    ctx.closePath();

    const g = ctx.createLinearGradient(-40,-30,40,130);
    g.addColorStop(0,"#7fd0ff");
    g.addColorStop(0.55,"#1f7bff");
    g.addColorStop(1,"#0b4fd6");
    ctx.fillStyle = g;
    ctx.fill();

    // highlight edge
    ctx.lineWidth = 5;
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.stroke();

    // inner highlight
    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.moveTo(-18,16);
    ctx.quadraticCurveTo(-2,-10, 16,-6);
    ctx.quadraticCurveTo(30,-3, 22,10);
    ctx.quadraticCurveTo(14,20, 2,26);
    ctx.quadraticCurveTo(-12,34, -18,44);
    ctx.quadraticCurveTo(-26,58, -10,58);
    ctx.lineTo(18,58);
    ctx.globalAlpha = 0.22;
    ctx.strokeStyle="#fff";
    ctx.lineWidth=4;
    ctx.stroke();
    ctx.globalAlpha = 1;

    // wick + holder
    ctx.strokeStyle="#1b1b1b"; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(6,-16); ctx.lineTo(6,-34); ctx.stroke();
    ctx.fillStyle="#0f3aa8";
    roundRect(-10,122,20,16,6); ctx.fill();

    ctx.restore();
  }

  function drawCandleNumber3(x,y){
    ctx.save();
    ctx.translate(x,y);

    ctx.globalAlpha = 0.12;
    ctx.beginPath(); ctx.ellipse(0,96,40,10,0,0,Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha = 1;

    // body path for 3
    ctx.beginPath();
    ctx.moveTo(-18,6);
    ctx.quadraticCurveTo(-2,-34, 26,-22);
    ctx.quadraticCurveTo(56,-10, 34,16);
    ctx.quadraticCurveTo(48,26, 42,42);
    ctx.quadraticCurveTo(62,58, 44,78);
    ctx.quadraticCurveTo(22,106, -8,94);
    ctx.quadraticCurveTo(-26,86, -30,70);
    ctx.quadraticCurveTo(-34,54, -18,48);
    ctx.quadraticCurveTo(-4,42, 10,48);
    ctx.quadraticCurveTo(20,52, 24,60);
    ctx.quadraticCurveTo(28,70, 18,74);
    ctx.quadraticCurveTo(6,80, -4,74);
    ctx.quadraticCurveTo(2,94, 22,90);
    ctx.quadraticCurveTo(38,86, 34,72);
    ctx.quadraticCurveTo(30,58, 12,58);
    ctx.lineTo(4,58);
    ctx.lineTo(4,44);
    ctx.quadraticCurveTo(30,44, 26,22);
    ctx.quadraticCurveTo(22,4, 0,10);
    ctx.quadraticCurveTo(-10,12, -18,22);
    ctx.closePath();

    const g = ctx.createLinearGradient(-40,-30,40,130);
    g.addColorStop(0,"#7fd0ff");
    g.addColorStop(0.55,"#1f7bff");
    g.addColorStop(1,"#0b4fd6");
    ctx.fillStyle = g;
    ctx.fill();

    ctx.lineWidth = 5;
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.stroke();

    // highlight streak
    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.moveTo(8,0);
    ctx.quadraticCurveTo(22,6, 18,20);
    ctx.quadraticCurveTo(14,34, 0,32);
    ctx.strokeStyle="#fff";
    ctx.lineWidth=4;
    ctx.stroke();
    ctx.globalAlpha = 1;

    // wick + holder
    ctx.strokeStyle="#1b1b1b"; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(10,-16); ctx.lineTo(10,-34); ctx.stroke();
    ctx.fillStyle="#0f3aa8";
    roundRect(-10,122,20,16,6); ctx.fill();

    ctx.restore();
  }

  function drawCake(){
    // background
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // confetti dots (subtle)
    for(let i=0;i<26;i++){
      const x=(i*37)%420, y=(i*71)%520;
      ctx.globalAlpha=0.18;
      ctx.beginPath();
      ctx.arc(x+14,y+20, 3+(i%3), 0, Math.PI*2);
      ctx.fillStyle=["#ff4fa3","#7c5cff","#00c2ff","#ffb300"][i%4];
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // plate shadow
    ctx.globalAlpha=0.15;
    ctx.beginPath();
    ctx.ellipse(210, 455, 170, 26, 0, 0, Math.PI*2);
    ctx.fillStyle="#000";
    ctx.fill();
    ctx.globalAlpha=1;

    // plate (teal like ref)
    ctx.beginPath();
    ctx.ellipse(210, 448, 180, 30, 0, 0, Math.PI*2);
    const pg = ctx.createLinearGradient(30,420,390,480);
    pg.addColorStop(0,"#6fe3de");
    pg.addColorStop(0.55,"#2bbfb6");
    pg.addColorStop(1,"#1aa39c");
    ctx.fillStyle=pg;
    ctx.fill();
    ctx.lineWidth=3;
    ctx.strokeStyle="rgba(255,255,255,.55)";
    ctx.stroke();

    // cake base shape (cylinder)
    // bottom body
    ctx.fillStyle="#f3d5b3";
    roundRect(90, 250, 240, 160, 42);
    ctx.fill();

    // top ellipse (cake top surface under chocolate)
    ctx.beginPath();
    ctx.ellipse(210, 250, 120, 26, 0, 0, Math.PI*2);
    ctx.fillStyle="#e9c8a5";
    ctx.fill();

    // chocolate frosting on top
    ctx.beginPath();
    ctx.ellipse(210, 238, 132, 30, 0, 0, Math.PI*2);
    ctx.fillStyle="#b77762";
    ctx.fill();

    // chocolate drip edge
    ctx.fillStyle="#b06f5a";
    const dripY = 250;
    ctx.beginPath();
    ctx.moveTo(78, dripY);
    const drips = [
      [110, dripY+28], [140, dripY+10],
      [175, dripY+34], [205, dripY+12],
      [240, dripY+36], [270, dripY+10],
      [305, dripY+28], [342, dripY+12]
    ];
    ctx.lineTo(78, dripY);
    for(let i=0;i<drips.length;i++){
      const [x,y] = drips[i];
      ctx.quadraticCurveTo(x-12, dripY, x, y);
      ctx.quadraticCurveTo(x+12, y, x+22, dripY);
    }
    ctx.lineTo(342, dripY);
    ctx.quadraticCurveTo(350, dripY-12, 350, dripY-22);
    ctx.quadraticCurveTo(350, 222, 330, 216);
    ctx.lineTo(90,216);
    ctx.quadraticCurveTo(70, 222, 70, dripY-22);
    ctx.quadraticCurveTo(70, dripY-10, 78, dripY);
    ctx.closePath();
    ctx.fill();

    // cream layers with wavy edges + sprinkles stars like ref
    // layer 1
    drawCreamBand(102, 290, 216, 56);
    // layer 2
    drawCreamBand(102, 350, 216, 56);

    // subtle side highlight
    ctx.globalAlpha=0.18;
    ctx.fillStyle="#fff";
    roundRect(98, 260, 34, 140, 18);
    ctx.fill();
    ctx.globalAlpha=1;

    // candles
    candle2.flick += 1;
    candle3.flick += 1;

    drawCandleNumber2(candle2.x, candle2.y);
    drawCandleNumber3(candle3.x, candle3.y);

    if (candle2.lit) flame(candle2.x+6, candle2.y-38, candle2.flick, 0.9);
    if (candle3.lit) flame(candle3.x+10, candle3.y-38, candle3.flick+10, 0.9);

    // title text
    ctx.fillStyle="rgba(0,0,0,.72)";
    ctx.font="800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign="center";
    ctx.fillText('Happy 23 üéâ', 210, 70);
    ctx.font="600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle="rgba(0,0,0,.45)";
    ctx.fillText('Blow into mic to blow out candles', 210, 92);

    // overlay message after blow
    if (showMsg) drawMessageOverlay();
  }

  function drawCreamBand(x,y,w,h){
    // cream
    ctx.fillStyle="#fff6e7";
    roundRect(x, y, w, h, 22);
    ctx.fill();

    // wavy top edge line
    ctx.strokeStyle="rgba(176,111,90,.55)";
    ctx.lineWidth=6;
    ctx.lineJoin="round";
    ctx.beginPath();
    ctx.moveTo(x+10, y+10);
    for(let i=0;i<8;i++){
      const px = x + 10 + i*(w-20)/7;
      const py = y + 10 + (i%2===0 ? 8 : -2);
      ctx.quadraticCurveTo(px+12, py, px+18, y+10);
    }
    ctx.stroke();

    // sprinkles (stars + dots)
    const colors = ["#ff4fa3","#7c5cff","#00c2ff","#ffb300","#ff6b6b","#34c759"];
    for(let i=0;i<16;i++){
      const sx = x + 18 + (i*17)% (w-36);
      const sy = y + 16 + (i*11)% (h-22);
      ctx.globalAlpha=0.95;
      if (i%3===0){
        ctx.fillStyle=colors[i%colors.length];
        star(sx,sy,6,(i*0.4));
        ctx.fill();
      } else {
        ctx.beginPath();
        ctx.arc(sx,sy, 2.6, 0, Math.PI*2);
        ctx.fillStyle=colors[(i+2)%colors.length];
        ctx.fill();
      }
    }
    ctx.globalAlpha=1;
  }

  // confetti for message
  function spawnConfetti(){
    confetti = [];
    for(let i=0;i<140;i++){
      confetti.push({
        x: Math.random()*420,
        y: -20 - Math.random()*520,
        vx: -1.2 + Math.random()*2.4,
        vy: 1.5 + Math.random()*3.2,
        r: 2 + Math.random()*4,
        rot: Math.random()*Math.PI,
        vr: -0.15 + Math.random()*0.3,
        c: ["#ff4fa3","#7c5cff","#00c2ff","#ffb300","#34c759","#ff6b6b"][i%6]
      });
    }
  }

  function drawMessageOverlay(){
    msgT += 1;

    // dim bg
    ctx.globalAlpha=0.62;
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,420,520);
    ctx.globalAlpha=1;

    // confetti animation
    for(const p of confetti){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      if(p.y > 560){
        p.y = -20;
        p.x = Math.random()*420;
      }
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle=p.c;
      roundRect(-p.r, -p.r/2, p.r*2, p.r, 2);
      ctx.fill();
      ctx.restore();
    }

    // card
    const pop = Math.min(1, msgT/18);
    const scale = 0.92 + pop*0.08;
    ctx.save();
    ctx.translate(210, 250);
    ctx.scale(scale, scale);

    ctx.globalAlpha=0.22;
    ctx.beginPath();
    ctx.ellipse(0, 120, 140, 20, 0, 0, Math.PI*2);
    ctx.fillStyle="#000"; ctx.fill();
    ctx.globalAlpha=1;

    ctx.fillStyle="#ffffff";
    roundRect(-160, -70, 320, 160, 22);
    ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,.08)";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.fillStyle="#111";
    ctx.textAlign="center";
    ctx.font="900 20px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("HAPPY BIRTHDAY", 0, -12);

    ctx.fillStyle="#ff2f92";
    ctx.font="950 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("L√ä VƒÇN L·ªòC", 0, 22);

    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.font="700 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("‚ú® Ch√∫c b·∫°n tu·ªïi 23 th·∫≠t r·ª±c r·ª°! ‚ú®", 0, 54);

    ctx.restore();
  }

  function allOut(){ return !candle2.lit && !candle3.lit; }

  function relight(){
    candle2.lit = true;
    candle3.lit = true;
    blowScore = 0;
    showMsg = false;
    msgT = 0;
    statusEl.textContent = 'Tr·∫°ng th√°i: N·∫øn ƒë√£ ƒë∆∞·ª£c th·∫Øp l·∫°i ‚ú®';
  }

  btnRelight.addEventListener('click', relight);

  function rmsFromTimeDomain(arr){
    let sum = 0;
    for (let i=0;i<arr.length;i++){
      const v = (arr[i] - 128) / 128;
      sum += v*v;
    }
    return Math.sqrt(sum / arr.length);
  }

  function frame(){
    drawCake();

    // audio + blow detect
    if (analyser && data && !showMsg){
      analyser.getByteTimeDomainData(data);
      const rms = rmsFromTimeDomain(data);

      const level = Math.min(100, Math.max(0, rms * 150));
      bar.style.width = level + '%';
      lvlText.textContent = level.toFixed(0);

      const threshold = Number(thresholdEl.value);

      if (level > threshold){
        const delta = Math.max(0, level - lastLevel);
        blowScore += 0.95 + (delta < 10 ? 0.55 : 0.15);
      } else {
        blowScore *= 0.92;
      }
      lastLevel = level;

      // extinguish one-by-one
      if (!allOut()){
        if (blowScore > 14){
          // t·∫Øt l·∫ßn l∆∞·ª£t: 2 r·ªìi 3
          if (candle2.lit) candle2.lit = false;
          else if (candle3.lit) candle3.lit = false;

          blowScore = 0;
          statusEl.textContent = 'Tr·∫°ng th√°i: T·∫Øt ƒë∆∞·ª£c 1 c√¢y! Ti·∫øp t·ª•c th·ªïi üí®';
          btnRelight.disabled = false;
        }
      } else {
        statusEl.textContent = 'Tr·∫°ng th√°i: C·∫£ hai n·∫øn ƒë√£ t·∫Øt! üéâ';
        // show message overlay
        showMsg = true;
        msgT = 0;
        spawnConfetti();
      }
    }

    rafId = requestAnimationFrame(frame);
  }

  async function startMic(){
    try{
      statusEl.textContent = 'Tr·∫°ng th√°i: ƒêang xin quy·ªÅn micro...';
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      data = new Uint8Array(analyser.fftSize);

      src.connect(analyser);

      btnStart.disabled = true;
      btnRelight.disabled = false;
      statusEl.textContent = 'Tr·∫°ng th√°i: Micro ƒë√£ b·∫≠t ‚úÖ H√£y th·ªïi v√†o micro!';
      if (!rafId) frame();
    } catch(err){
      console.error(err);
      statusEl.textContent = 'Tr·∫°ng th√°i: Kh√¥ng b·∫≠t ƒë∆∞·ª£c micro ‚ùå (h√£y d√πng HTTPS/cho ph√©p quy·ªÅn micro)';
    }
  }

  btnStart.addEventListener('click', startMic);

  // initial render
  drawCake();
})();
</script>
</body>
</html>
